#!/bin/bash
echo "=== STOPPING SERVICES ==="
systemctl stop kubelet 2>/dev/null
systemctl disable kubelet 2>/dev/null

systemctl stop containerd 2>/dev/null
systemctl disable containerd 2>/dev/null

systemctl stop docker 2>/dev/null
systemctl disable docker 2>/dev/null

echo "=== REMOVING PACKAGES ==="
# RHEL/CentOS/Oracle
yum remove -y kubeadm kubectl kubelet kubernetes-cni containerd.io containerd docker docker-ce 2>/dev/null

# Debian/Ubuntu (ignore errors)
apt purge -y kubeadm kubectl kubelet kubernetes-cni containerd.io containerd docker docker-ce 2>/dev/null

echo "=== DELETING KUBERNETES DIRECTORIES ==="
rm -rf /etc/kubernetes
rm -rf /var/lib/etcd
rm -rf /var/lib/kubelet
rm -rf /var/lib/dockershim
rm -rf /var/lib/cni
rm -rf /run/flannel
rm -rf /etc/cni
rm -rf /opt/cni
rm -rf ~/.kube

echo "=== DELETING CALICO DIRECTORIES ==="
rm -rf /etc/calico
rm -rf /var/lib/calico

echo "=== REMOVING CONTAINERD DIRECTORIES ==="
rm -rf /var/lib/containerd
rm -rf /etc/containerd
rm -rf /run/containerd

echo "=== REMOVING DOCKER DIRECTORIES ==="
rm -rf /var/lib/docker
rm -rf /etc/docker
rm -rf /run/docker

echo "=== REMOVING OVERLAY/OVERLAY2 STORAGE ==="
rm -rf /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs
rm -rf /var/lib/containerd/io.containerd.snapshotter.v1.btrfs
rm -rf /var/lib/containerd/io.containerd.snapshotter.v1.native
rm -rf /var/lib/containerd/io.containerd.snapshotter.v1.zfs

rm -rf /var/lib/docker/overlay
rm -rf /var/lib/docker/overlay2

echo "=== UNMOUNTING ANY OVERLAY MOUNTS ==="
for m in $(mount | grep overlay | awk '{print $3}'); do
    umount -l $m 2>/dev/null
done

echo "=== REMOVING CALICO NETWORK INTERFACES ==="
ip link del tunl0 2>/dev/null
ip link del vxlan.calico 2>/dev/null
ip link del cni0 2>/dev/null
ip link del flannel.1 2>/dev/null

echo "=== FLUSHING IPTABLES ==="
iptables -F
iptables -X
iptables -t nat -F
iptables -t nat -X
iptables -t mangle -F
iptables -t mangle -X
iptables -t raw -F
iptables -t raw -X

echo "=== DELETING SYSTEMD SERVICES ==="
rm -f /etc/systemd/system/kubelet.service
rm -f /etc/systemd/system/containerd.service
rm -f /etc/systemd/system/docker.service
systemctl daemon-reload

echo "=== CLEANING NETWORK CONFIG (OPTIONAL) ==="
rm -rf /var/lib/systemd/network
rm -rf /var/lib/networkd

echo "=== CLEANUP COMPLETE ==="
echo "REBOOTING IS HIGHLY RECOMMENDED!"
