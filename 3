Your **Calico pods are stuck in Pending/CrashLoopBackOff** because **CNI installation is failing** *and* **Calico cannot talk to the API server due to a Kubernetes certificate trust mismatch**.

Both issues are connected, and I‚Äôll break it down clearly with the exact steps to fix them.

---

# ‚úÖ **ISSUE 1 ‚Äî install-cni is CrashLoopBackOff**

### **Error**

```
install-cni ‚Üí Exit Code 1
```

This means Calico is failing to install `/etc/cni/net.d/10-calico.conflist` on the node.

### Possible causes

1. Old CNI files still exist
2. Wrong directory permissions
3. Conflicting CNI plugin (weave, flannel, old calico)
4. Missing `/opt/cni/bin` or `/etc/cni/net.d` on the host
5. ContainerD was reinstalled recently (CNI directory emptied)

---

# üîß **FIX ISSUE 1 ‚Äî Clean and recreate CNI directories**

### **1. Remove old CNI config**

Run on each node:

```bash
sudo rm -rf /etc/cni/net.d/*
sudo rm -rf /var/lib/cni/networks/*
```

---

### **2. Ensure CNI directories exist**

```bash
sudo mkdir -p /etc/cni/net.d
sudo mkdir -p /opt/cni/bin
sudo mkdir -p /var/lib/cni/networks
```

---

### **3. Restart containerd**

```bash
sudo systemctl restart containerd
```

---

### **4. Restart kubelet**

```bash
sudo systemctl restart kubelet
```

Then watch:

```bash
kubectl get pods -n kube-system -w
```

---

# ‚ùå **ISSUE 2 ‚Äî TLS certificate error with API server**

You have this critical error:

```
tls: failed to verify certificate: x509: certificate signed by unknown authority
```

This means **Calico does not trust the Kube API Server certificate**.

### This **always happens** when:

* You **reinstalled containerd** or deleted `/var/lib/kubelet/pki`
* You regenerated cluster certificates (maybe due to upgrade)
* The API server certificate changed but the node still has old CA certs

---

# üîß **FIX ISSUE 2 ‚Äî Replace API server CA on all nodes**

### **1. Verify CA file mounted by kubelet**

The CA used by Calico is:

```
/etc/kubernetes/pki/ca.crt
```

On the node compare:

```bash
openssl x509 -in /etc/kubernetes/pki/ca.crt -noout -fingerprint
```

Compare with API server cert:

```bash
openssl s_client -connect 10.96.0.1:443 -showcerts </dev/null 2>/dev/null | openssl x509 -noout -fingerprint
```

If fingerprints differ ‚Üí **Kubelet CA is invalid**.

---

### **2. Replace incorrect CA**

Copy CA from master node:

```bash
scp root@<control-plane>:/etc/kubernetes/pki/ca.crt /etc/kubernetes/pki/ca.crt
```

---

### **3. Restart kubelet**

```bash
sudo systemctl restart kubelet
```

---

### **4. Verify API access**

From node:

```bash
curl --cacert /etc/kubernetes/pki/ca.crt https://10.96.0.1:443/version
```

Should return JSON.

---

# üß© WHY ARE BOTH PODS STUCK?

### **calico-node**

Cannot install CNI ‚Üí CrashLoopBackOff

### **calico-kube-controllers**

Cannot communicate with API because of CA mismatch:

```
x509: certificate signed by unknown authority
```

Until both problems are fixed, Calico will never start.

---

# üíØ **FINAL CHECKLIST ‚Äî Run in order**

### **Step 1 ‚Äî Cleanup CNI directories**

```
rm -rf /etc/cni/net.d/*
rm -rf /var/lib/cni/networks/*
```

### **Step 2 ‚Äî Ensure CNI directories exist**

```
mkdir -p /etc/cni/net.d /opt/cni/bin /var/lib/cni/networks
```

### **Step 3 ‚Äî Fix Kubernetes CA mismatch**

Replace `/etc/kubernetes/pki/ca.crt` with the correct one.

### **Step 4 ‚Äî Restart services**

```
systemctl restart containerd
systemctl restart kubelet
```

### **Step 5 ‚Äî Delete stuck Calico pods**

```
kubectl delete pod -n kube-system -l k8s-app=calico-node
kubectl delete pod -n kube-system -l k8s-app=calico-kube-controllers
```

They will recreate automatically.

---

# If you want, I can:

‚úî Check logs from Calico:

```
kubectl logs <pod> -n kube-system -c install-cni
```

‚úî Validate your CA file
‚úî Help rebuild Calico YAML with correct settings
‚úî Verify API server certificate chain

Just send me:

```
journalctl -u kubelet -f | head -n 50
```

I‚Äôll guide you line by line.
